<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>

<body>
    <div id="devices"></div>
    <button id="ble">do it</button>
    <button id="start">start</button>
    <button id="resume">resume</button>
    <button id="pause">pause</button>
    <button id="stop">stop</button>

    <button id="1mph">1mph</button>

    <br>
    <span id="status"></span>
    <script src="webble.js"></script>

    <script>


        let button = document.querySelector('#ble');
        button.addEventListener('click', doBleStuff);

        let deviceManager = new DeviceManager();
        deviceManager.init();

        async function doBleStuff() {
            // if(deviceManager.knownDevices.size < 1) {
            await deviceManager.findNewDevice();
            // }
            // let deviceState;
            // for(let dev of deviceManager.knownDevices.values()) { deviceState = dev; }


            // document.querySelector('#status').textContent = 'connected';
            // device.addEventListener('gattserverdisconnected', () => document.querySelector('#status').textContent = 'disconnected');




            // const btPermission = await navigator.permissions.query({ name: "bluetooth" });
            // if (btPermission.state !== "denied") {
            // // Do something
            // }
        }







        let devicesList = document.querySelector('#devices');

        deviceManager.emitter.on('deviceAdded', showDevice);

        const domByDevice = new Map();

        let selectedDevice = null;



        async function showDevice(deviceState) {
            let domElement = document.createElement('div');
            domElement.innerHTML = `device: ${deviceState.device.name}; CONNECTED: <span class="status"></span>; SIGNAL: <span class="rssi">${deviceState.lastAdvertisement?.rssi}</span>
                                <button id="useDevice">switch to device</button>
                                `;//TODO

            let deviceStateWrapper = {
                deviceState,
            };

            let render = renderDevice.bind(null, deviceStateWrapper, domElement);
            deviceState.emitter.on('connected', async () => {
                render();

                await setupNotify(deviceStateWrapper, selectedDevice);
            });
            deviceState.emitter.on('disconnected', render);
            deviceState.emitter.on('advertisementreceived', render);


            domByDevice.set(deviceState, domElement);

            devicesList.appendChild(domElement);

            render();

            if (!selectedDevice) {
                selectDevice(deviceStateWrapper);
            }
        }

        async function setupNotify(deviceStateWrapper, oldDevice) {
            if (oldDevice !== null) { /* TODO */ }

            let gotIt = false;
            await deviceManager.useDevice(deviceStateWrapper.deviceState, async characteristics => {
                await characteristics.treadmillData.startNotifications();

                characteristics.treadmillData.addEventListener('characteristicvaluechanged', () => {
                    console.log('VALUE RECEIVED!!!')


                if(gotIt) return;
                alert('got it');
                gotIt = true;

                    let value = characteristics.treadmillData.value;
                    let a = [];
                    // Convert raw data bytes to hex values just for the sake of showing something.
                    // In the "real" world, you'd use data.getUint8, data.getUint16 or even
                    // TextDecoder to process raw data bytes.
                    let hdr = value.getUint16(0);

                    let fieldOffsets = {
                    };

                    let offset = 0;
                    if (hdr & (1 << 15)) {
                        fieldOffsets.speed = {
                            offset,
                            size: 2
                        };
                        offset += 2; // 2 bytes
                    }
                    if (hdr & (1 << 14)) {
                        fieldOffsets.avgSpeed = {
                            offset,
                            size: 2
                        };
                        offset += 2; // 2 bytes
                    }
                    if (hdr & (1 << 13)) {
                        fieldOffsets.totalDistance = {
                            offset,
                            size: 3
                        };
                        offset += 3; // 3 bytes
                    }
                    if (hdr & (1 << 12)) {
                        fieldOffsets.incline = {
                            offset,
                            size: 2
                        };
                        offset += 2; // 2 bytes
                        fieldOffsets.angle = {
                            offset,
                            size: 2
                        };
                        offset += 2; // 2 bytes
                    }
                    if (hdr & (1 << 11)) {
                        fieldOffsets.elevationGain = {
                            offset,
                            size: 2
                        };
                        offset += 2; // 2 bytes
                        fieldOffsets.negativeElevationGain = {
                            offset,
                            size: 2
                        };
                        offset += 2; // 2 bytes
                    }
                    if (hdr & (1 << 10)) {
                        fieldOffsets.pace = {
                            offset,
                            size: 1
                        };
                        offset += 1; // 1 byte
                    }
                    if (hdr & (1 << 9)) {
                        fieldOffsets.avgPace = {
                            offset,
                            size: 1
                        };
                        offset += 1; // 1 byte
                    }
                    if (hdr & (1 << 8)) {
                        fieldOffsets.energy = {
                            offset,
                            size: 2
                        };
                        offset += 2; // 2 bytes
                        fieldOffsets.energyPerHour = {
                            offset,
                            size: 2
                        };
                        offset += 2; // 2 bytes
                        fieldOffsets.energyPerMinute = {
                            offset,
                            size: 1
                        };
                        offset += 1; // 2 byte
                    }
                    if (hdr & (1 << 7)) {
                        fieldOffsets.heartRate = {
                            offset,
                            size: 1
                        };
                        offset += 1; // 1 byte
                    }
                    if (hdr & (1 << 6)) {
                        fieldOffsets.metabolic = {
                            offset,
                            size: 1
                        };
                        offset += 1; // 1 byte
                    }
                    if (hdr & (1 << 5)) {
                        fieldOffsets.elapsedTime = {
                            offset,
                            size: 2
                        };
                        offset += 2; // 2 bytes
                    }
                    if (hdr & (1 << 4)) {
                        fieldOffsets.remainingTime = {
                            offset,
                            size: 2
                        };
                        offset += 2; // 2 bytes
                    }
                    if (hdr & (1 << 3)) {
                        fieldOffsets.beltForce = {
                            offset,
                            size: 2
                        };
                        offset += 2; // 2 bytes
                        fieldOffsets.powerOutput = {
                            offset,
                            size: 2
                        };
                        offset += 2; // 2 bytes
                    }

                    let fields = Object.fromEntries(Object.keys(fieldOffsets).map(fieldName => {
                        let val = 0;
                        for(let i = 0; i < fieldOffsets[fieldName].size; ++i) {
                            val <<= 8;
                            val += value.getUint8(fieldOffsets[fieldName].offset + i);
                        }
                        return [fieldName, val]; 
                    }));
                    
                    console.log(fields);


                });

                console.log('awaiting notifications...');
            }, true);

            
        }

        function selectDevice(deviceStateWrapper) {
            selectedDevice = deviceStateWrapper;
        }

        function renderDevice(device, domElement) {
            domElement.querySelector('.rssi').textContent = device.deviceState.lastAdvertisement?.rssi + '';
            domElement.querySelector('.status').textContent = device.deviceState.connected;
        }

        document.querySelector('#start').addEventListener('click', async () => {
            // debugger;
            let cmdStr = '02530100000000000000000e03';
            let cmdBuffer = new Uint8Array(cmdStr.length / 2);
            for (let i = 0; i < cmdStr.length; i += 2) {
                cmdBuffer[i / 2] = parseInt(cmdStr.slice(i, i + 2), 16);
            }

            await deviceManager.useDevice(selectedDevice.deviceState, async characteristics => {
                await characteristics.sendCommand.writeValueWithoutResponse(cmdBuffer);
            }, true);
            // await c.writeValueWithoutResponse(cmdBuffer);
        })
        document.querySelector('#resume').addEventListener('click', async () => {
            // debugger;
            let cmdStr = '0253090603';
            let cmdBuffer = new Uint8Array(cmdStr.length / 2);
            for (let i = 0; i < cmdStr.length; i += 2) {
                cmdBuffer[i / 2] = parseInt(cmdStr.slice(i, i + 2), 16);
            }
            await deviceManager.useDevice(selectedDevice.deviceState, async characteristics => {
                await characteristics.sendCommand.writeValueWithoutResponse(cmdBuffer);
            }, true);
            // await c.writeValueWithoutResponse(cmdBuffer);
        })

        document.querySelector('#pause').addEventListener('click', async () => {
            // debugger;
            let cmdStr = '02530a0703';
            let cmdBuffer = new Uint8Array(cmdStr.length / 2);
            for (let i = 0; i < cmdStr.length; i += 2) {
                cmdBuffer[i / 2] = parseInt(cmdStr.slice(i, i + 2), 16);
            }
            await deviceManager.useDevice(selectedDevice.deviceState, async characteristics => {
                await characteristics.sendCommand.writeValueWithoutResponse(cmdBuffer);
            }, true);
            // await c.writeValueWithoutResponse(cmdBuffer);
        })

        document.querySelector('#stop').addEventListener('click', async () => {
            // debugger;
            let cmdStr = '0253030c03';
            let cmdBuffer = new Uint8Array(cmdStr.length / 2);
            for (let i = 0; i < cmdStr.length; i += 2) {
                cmdBuffer[i / 2] = parseInt(cmdStr.slice(i, i + 2), 16);
            }
            await deviceManager.useDevice(selectedDevice.deviceState, async characteristics => {
                await characteristics.sendCommand.writeValueWithoutResponse(cmdBuffer);
            }, true);
            // await c.writeValueWithoutResponse(cmdBuffer);
        })








    </script>

</body>

</html>