var N=Object.defineProperty;var O=(n,e,t)=>e in n?N(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var b=(n,e,t)=>O(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const l of a)if(l.type==="childList")for(const m of l.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&r(m)}).observe(document,{childList:!0,subtree:!0});function t(a){const l={};return a.integrity&&(l.integrity=a.integrity),a.referrerPolicy&&(l.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?l.credentials="include":a.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function r(a){if(a.ep)return;a.ep=!0;const l=t(a);fetch(a.href,l)}})();function P(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var L={exports:{}},C;function k(){return C||(C=1,function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function a(d,s,c){this.fn=d,this.context=s,this.once=c||!1}function l(d,s,c,o,h){if(typeof c!="function")throw new TypeError("The listener must be a function");var p=new a(c,o||d,h),f=t?t+s:s;return d._events[f]?d._events[f].fn?d._events[f]=[d._events[f],p]:d._events[f].push(p):(d._events[f]=p,d._eventsCount++),d}function m(d,s){--d._eventsCount===0?d._events=new r:delete d._events[s]}function u(){this._events=new r,this._eventsCount=0}u.prototype.eventNames=function(){var s=[],c,o;if(this._eventsCount===0)return s;for(o in c=this._events)e.call(c,o)&&s.push(t?o.slice(1):o);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(c)):s},u.prototype.listeners=function(s){var c=t?t+s:s,o=this._events[c];if(!o)return[];if(o.fn)return[o.fn];for(var h=0,p=o.length,f=new Array(p);h<p;h++)f[h]=o[h].fn;return f},u.prototype.listenerCount=function(s){var c=t?t+s:s,o=this._events[c];return o?o.fn?1:o.length:0},u.prototype.emit=function(s,c,o,h,p,f){var y=t?t+s:s;if(!this._events[y])return!1;var i=this._events[y],g=arguments.length,D,v;if(i.fn){switch(i.once&&this.removeListener(s,i.fn,void 0,!0),g){case 1:return i.fn.call(i.context),!0;case 2:return i.fn.call(i.context,c),!0;case 3:return i.fn.call(i.context,c,o),!0;case 4:return i.fn.call(i.context,c,o,h),!0;case 5:return i.fn.call(i.context,c,o,h,p),!0;case 6:return i.fn.call(i.context,c,o,h,p,f),!0}for(v=1,D=new Array(g-1);v<g;v++)D[v-1]=arguments[v];i.fn.apply(i.context,D)}else{var q=i.length,E;for(v=0;v<q;v++)switch(i[v].once&&this.removeListener(s,i[v].fn,void 0,!0),g){case 1:i[v].fn.call(i[v].context);break;case 2:i[v].fn.call(i[v].context,c);break;case 3:i[v].fn.call(i[v].context,c,o);break;case 4:i[v].fn.call(i[v].context,c,o,h);break;default:if(!D)for(E=1,D=new Array(g-1);E<g;E++)D[E-1]=arguments[E];i[v].fn.apply(i[v].context,D)}}return!0},u.prototype.on=function(s,c,o){return l(this,s,c,o,!1)},u.prototype.once=function(s,c,o){return l(this,s,c,o,!0)},u.prototype.removeListener=function(s,c,o,h){var p=t?t+s:s;if(!this._events[p])return this;if(!c)return m(this,p),this;var f=this._events[p];if(f.fn)f.fn===c&&(!h||f.once)&&(!o||f.context===o)&&m(this,p);else{for(var y=0,i=[],g=f.length;y<g;y++)(f[y].fn!==c||h&&!f[y].once||o&&f[y].context!==o)&&i.push(f[y]);i.length?this._events[p]=i.length===1?i[0]:i:m(this,p)}return this},u.prototype.removeAllListeners=function(s){var c;return s?(c=t?t+s:s,this._events[c]&&m(this,c)):(this._events=new r,this._eventsCount=0),this},u.prototype.off=u.prototype.removeListener,u.prototype.addListener=u.prototype.on,u.prefixed=t,u.EventEmitter=u,n.exports=u}(L)),L.exports}var R=k();const U=P(R);class ${constructor(){b(this,"knownDevices",new Map);b(this,"emitter",new U)}async init(e){for(let t of await navigator.bluetooth.getDevices()){let r=!1;for(let a of e)if(a.supports(t)){r=!0;let l=this._initDeviceState(t,a);this.emitter.emit("deviceAdded",l);break}r||console.error("Unsupported device connected?!")}await this.watchAdvertisements()}async findNewDevice(e){const t=await navigator.bluetooth.requestDevice(e.scanFilters);if(t){let r=this._initDeviceState(t,e);this.emitter.emit("deviceAdded",r)}}_initDeviceState(e,t){let r={device:e,driver:t,autoConnect:!1,connected:!1,inUse:!1,promise:new Promise(a=>a(null)),emitter:new U};return this.knownDevices.set(e,r),e.addEventListener("gattserverdisconnected",()=>{r.connected=!1,r.emitter.emit("disconnected",r)}),r}async useDevice(e,t,r){if(!e)throw new Error("device not found");return await e.promise,e.promise=this._useDevice(e,t,r)}async _useDevice(e,t,r){const l=e.device.gatt;if(!e.connected){if(!r)throw new Error("was not connected, and autoconnect=false");if(!l)throw new Error("Internal bluetooth error - no gatt?!");await l.connect(),e.connected=!0,await e.driver.initializeState(l,e),e.emitter.emit("connected",e)}if(!e._characteristics)throw new Error("internal driver issue - uninitialized characteristics");await t(e._characteristics)}async watchAdvertisements(){let e=[];for(let t of this.knownDevices.keys())t.addEventListener("advertisementreceived",r=>this._advertisementReceived(r)),e.push(t.watchAdvertisements());await Promise.all(e)}_advertisementReceived(e){let t=this.knownDevices.get(e.device);t&&(t.lastAdvertisement=e,t.emitter.emit("advertisementreceived"))}}class M{constructor(){b(this,"scanFilters",{filters:[{services:[6182]}],optionalServices:[65520,65248]})}supports(e){return!0}async initializeState(e,t){let l=await(await e.getPrimaryServices(65520)).find(u=>u.uuid.includes("fff0")).getCharacteristics(),m={sendCommand:l.find(u=>u.uuid.includes("fff2")),treadmillData:l.find(u=>u.uuid.includes("fff1"))};if(!m.sendCommand||!m.treadmillData)throw new Error(`Missing characteristics!! ${m.sendCommand}:${m.treadmillData}`);t._characteristics=m}}let V=document.querySelector("#ble");V.addEventListener("click",T);let A=new M,w=new $;w.init([A]);async function T(){await w.findNewDevice(A)}let W=document.querySelector("#devices");w.emitter.on("deviceAdded",F);const I=new Map;let _;async function F(n){var a;let e=document.createElement("div");e.innerHTML=`device: ${n.device.name}; CONNECTED: <span class="status"></span>; SIGNAL: <span class="rssi">${(a=n.lastAdvertisement)==null?void 0:a.rssi}</span>
                        <button id="useDevice">switch to device</button>
                        `;let t={deviceState:n},r=B.bind(null,t,e);n.emitter.on("connected",async()=>{r(),w.useDevice(n,l=>j(l),!1)}),n.emitter.on("disconnected",r),n.emitter.on("advertisementreceived",r),I.set(n,e),W.appendChild(e),r(),_||z(t)}async function j(n,e,t){console.log("enabling characteristics"),await n.treadmillData.startNotifications(),n.treadmillData.addEventListener("characteristicvaluechanged",()=>{console.log("VALUE RECEIVED!!!");const r=n.treadmillData.value;if(r.getUint8(2)!==3){console.log("treadmill asleep....");return}let l=r.getUint8(3),m=r.getUint8(4),u=r.getUint16(5,!0),d=r.getUint16(7,!0);document.querySelector("#status").textContent=`SPEED: ${l/10}mph - INCLINE: ${m} - T: ${(""+Math.floor(u/60)).padStart(2,"0")}:${(""+u%60).padStart(2,"0")} - ${d/100}mi`}),console.log("awaiting notifications...")}function z(n){_=n}function B(n,e){var t;e.querySelector(".rssi").textContent=((t=n.deviceState.lastAdvertisement)==null?void 0:t.rssi)+"",e.querySelector(".status").textContent=`${n.deviceState.connected}`}document.querySelector("#start").addEventListener("click",async()=>{await w.useDevice(_.deviceState,async n=>{await n.sendCommand.writeValueWithoutResponse(S("02530100000000000000000e03"))},!0)});document.querySelector("#resume").addEventListener("click",async()=>{await w.useDevice(_.deviceState,async n=>{await n.sendCommand.writeValueWithoutResponse(S("0253090603"))},!0)});function x(){let n=Number(document.querySelector("#speed").value),e=Number(document.querySelector("#incline").value),t=new Uint8Array(7),r=new DataView(t.buffer);r.setUint8(0,2),r.setUint8(1,83),r.setUint8(2,2),r.setUint8(3,n),r.setUint8(4,e);let a=r.getUint8(1)+r.getUint8(2)+r.getUint8(3)+r.getUint8(4);return a^=90,r.setUint8(5,a),r.setUint8(6,3),t.buffer}document.querySelector("#speed").addEventListener("input",async n=>{await w.useDevice(_.deviceState,async e=>{await e.sendCommand.writeValueWithoutResponse(x())},!0)});document.querySelector("#incline").addEventListener("input",async n=>{await w.useDevice(_.deviceState,async e=>{await e.sendCommand.writeValueWithoutResponse(x())},!0)});function S(n){let e=new Uint8Array(n.length/2);for(let t=0;t<n.length;t+=2)e[t/2]=parseInt(n.slice(t,t+2),16);return e}document.querySelector("#pause").addEventListener("click",async()=>{await w.useDevice(_.deviceState,async n=>{await n.sendCommand.writeValueWithoutResponse(S("02530a0703"))},!0)});document.querySelector("#stop").addEventListener("click",async()=>{await w.useDevice(_.deviceState,async n=>{await n.sendCommand.writeValueWithoutResponse(S("0253030c03"))},!0)});
